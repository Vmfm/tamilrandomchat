<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Random Video Chat - Tamil VM</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body{font-family:sans-serif;background:#111;color:#eee;margin:0;padding:0}
    #videoContainer{position:relative;width:100%;height:70vh;background:#000;display:flex;justify-content:center;align-items:center}
    #remoteVideo,#localVideo{object-fit:cover}
    #remoteVideo{width:100%;height:100%}
    #localVideo{position:absolute;top:10px;right:10px;width:160px;height:120px;border:2px solid #fff;border-radius:8px;z-index:2}
    #waitingOverlay{position:absolute;inset:0;background:rgba(0,0,0,0.7);color:#fff;font-size:22px;display:flex;flex-direction:column;justify-content:center;align-items:center;gap:10px;z-index:5}
    .spinner{width:40px;height:40px;border:5px solid #777;border-top:5px solid #fff;border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    .controls{text-align:center;margin:15px}
    button{padding:10px 15px;margin:4px;border:none;border-radius:6px;font-size:16px;color:#fff;cursor:pointer}
    #startBtn{background:#2563eb}
    #nextBtn{background:#10b981}
    #hangBtn{background:#ef4444}
    #muteBtn{background:#f59e0b}
    #camBtn{background:#8b5cf6}
  </style>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
</head>

<body>
  <h2 style="text-align:center">ðŸ”¥ Random Video - Tamil VM</h2>

  <div id="videoContainer">
    <video id="remoteVideo" autoplay playsinline></video>
    <video id="localVideo" autoplay muted playsinline></video>

    <div id="waitingOverlay">
      <div class="spinner"></div>
      <div>Waiting for partner...</div>
    </div>
  </div>

  <div class="controls">
    <button id="startBtn">Find Partner</button>
    <button id="nextBtn" disabled>Next</button>
    <button id="hangBtn" disabled>Hang Up</button>
    <button id="muteBtn" disabled>Mute</button>
    <button id="camBtn" disabled>Camera Off</button>
  </div>

<script>
(async function(){

  // ---------------- FIREBASE INIT ----------------
  const firebaseConfig = {
    apiKey: "AIzaSyB1VbLbqBxCiG_bfGoQgQyapXwHUQ-Q7BU",
    authDomain: "tamil-chat-2d54e.firebaseapp.com",
    databaseURL: "https://tamil-chat-2d54e-default-rtdb.firebaseio.com",
    projectId: "tamil-chat-2d54e",
    storageBucket: "tamil-chat-2d54e.appspot.com",
    messagingSenderId: "804705969240",
    appId: "1:804705969240:web:658df281dd8360843c162d"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // ðŸ”¥ Anonymous login (REQUIRED for secure rules)
  await firebase.auth().signInAnonymously();

  // ---------------- DOM ----------------
  const localVideo = document.getElementById("localVideo");
  const remoteVideo = document.getElementById("remoteVideo");
  const waitingOverlay = document.getElementById("waitingOverlay");

  const startBtn = document.getElementById("startBtn");
  const nextBtn = document.getElementById("nextBtn");
  const hangBtn = document.getElementById("hangBtn");
  const muteBtn = document.getElementById("muteBtn");
  const camBtn = document.getElementById("camBtn");

  // ---------------- VARIABLES ----------------
  let clientId = "u_" + Math.random().toString(36).substr(2,8);
  let queueKey = null, callId = null, isInitiator = false;
  let pc = null, localStream = null;
  let localCandidatesRef = null, remoteCandidatesRef = null;

  const iceConfig = { iceServers: [{ urls:"stun:stun.l.google.com:19302" }] };

  // ---------------- FUNCTIONS ----------------

  async function getLocalStream(){
    if (localStream) return localStream;
    localStream = await navigator.mediaDevices.getUserMedia({video:true,audio:true});
    localVideo.srcObject = localStream;
    return localStream;
  }

  function showOverlay(v){ waitingOverlay.style.display = v ? "flex" : "none"; }

  async function enterQueue(){
    const ref = db.ref("queue");
    const newRef = ref.push();
    queueKey = newRef.key;

    await newRef.set({ id: clientId, ts: Date.now() });
    newRef.onDisconnect().remove();

    showOverlay(true);
    watchQueue();
    watchPair();
  }

  function watchQueue(){
    db.ref("queue").on("child_added", async snap => {
      if (snap.key === queueKey) return;

      const other = snap.key;
      const pairRef = db.ref("pairs/"+other);

      await pairRef.transaction(cur=>{
        if (cur === null) return { a: other, b: queueKey };
        return;
      }, (err, committed)=>{
        if (committed) {
          const ids = [other, queueKey].sort();
          callId = "call_"+ids[0]+"_"+ids[1];
          isInitiator = true;

          db.ref("queue/"+other).remove();
          db.ref("queue/"+queueKey).remove();

          startCall(callId);
        }
      });
    });
  }

  function watchPair(){
    db.ref("pairs/"+queueKey).on("value", snap=>{
      const val = snap.val();
      if (!val || callId) return;

      const other = val.a===queueKey ? val.b : val.a;
      const ids = [other, queueKey].sort();
      callId = "call_"+ids[0]+"_"+ids[1];
      isInitiator = false;

      db.ref("queue/"+other).remove();
      db.ref("queue/"+queueKey).remove();

      startCall(callId);
    });
  }

  // ---------------- WebRTC CALL ----------------

  async function startCall(id){

    await getLocalStream();
    pc = new RTCPeerConnection(iceConfig);
    localStream.getTracks().forEach(track=>pc.addTrack(track, localStream));

    pc.ontrack = e => remoteVideo.srcObject = e.streams[0];

    pc.onicecandidate = e=>{
      if (e.candidate && localCandidatesRef)
        localCandidatesRef.push(e.candidate.toJSON());
    };

    const callRef = db.ref("calls/"+id);
    const offerRef = callRef.child("offer");
    const answerRef = callRef.child("answer");

    localCandidatesRef = callRef.child(isInitiator ? "offerCandidates" : "answerCandidates");
    remoteCandidatesRef = callRef.child(isInitiator ? "answerCandidates" : "offerCandidates");

    remoteCandidatesRef.on("child_added", snap=>{
      const c = snap.val();
      pc.addIceCandidate(new RTCIceCandidate(c));
    });

    if (isInitiator){
      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);
      offerRef.set({type:offer.type, sdp:offer.sdp});

      answerRef.on("value", async snap=>{
        const data = snap.val();
        if (data && data.sdp)
          await pc.setRemoteDescription(new RTCSessionDescription(data));
      });
    } else {
      offerRef.on("value", async snap=>{
        const data = snap.val();
        if (!data || !data.sdp) return;

        await pc.setRemoteDescription(new RTCSessionDescription(data));

        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);
        answerRef.set({type:answer.type, sdp:answer.sdp});
      });
    }

    showOverlay(false);

    startBtn.disabled = true;
    nextBtn.disabled = false;
    hangBtn.disabled = false;
    muteBtn.disabled = false;
    camBtn.disabled = false;
  }

  // ---------------- HANG UP ----------------
  async function hangUp(){
    if (pc) pc.close();
    if (callId) await db.ref("calls/"+callId).remove();

    callId = null;
    pc = null;

    startBtn.disabled = false;
    nextBtn.disabled = true;
    hangBtn.disabled = true;

    showOverlay(true);
  }

  // ---------------- BUTTONS ----------------
  startBtn.onclick = () => getLocalStream().then(enterQueue);
  nextBtn.onclick = async () => { await hangUp(); enterQueue(); };
  hangBtn.onclick = hangUp;

  muteBtn.onclick = ()=>{
    let t = localStream.getAudioTracks()[0];
    t.enabled = !t.enabled;
    muteBtn.textContent = t.enabled ? "Mute" : "Unmute";
  };

  camBtn.onclick = ()=>{
    let t = localStream.getVideoTracks()[0];
    t.enabled = !t.enabled;
    camBtn.textContent = t.enabled ? "Camera Off" : "Camera On";
  };

})();
</script>

</body>
</html>
