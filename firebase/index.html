<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Random Video Chat - Tamil VM</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { 
      font-family: Arial, sans-serif; 
      background: #fff; 
      margin: 0; 
      padding: 0; 
      text-align: center; 
    }
    h2 { margin: 10px; }
    #videoContainer {
      position: relative;
      width: 95%;
      max-width: 900px;
      height: 60vh;
      background: #000;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #remoteVideo { 
      width: 100%; 
      height: 100%; 
      object-fit: cover; 
      background: #000; 
    }
    #localVideo {
      position: absolute;
      bottom: 10px;
      right: 10px;
      width: 140px;
      height: 100px;
      object-fit: cover;
      border: 2px solid #fff;
      border-radius: 4px;
    }
    #waitingOverlay {
      position: absolute; 
      top: 0; left: 0; right: 0; bottom: 0;
      display: flex; 
      justify-content: center; 
      align-items: center;
      color: #fff; 
      background: rgba(0,0,0,0.6);
      font-size: 18px;
    }
    .controls {
      margin-top: 15px;
    }
    button {
      padding: 10px 14px;
      margin: 5px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      color: #fff;
      cursor: pointer;
    }
    .male { background: #1d4ed8; }
    .female { background: #16a34a; }
    .next { background: #f59e0b; }
    .mic { background: #dc2626; }
    .cam { background: #8b5cf6; }
    .cancel { background: #6b7280; }
    #status { display: block; margin-top: 10px; color: #555; }
    #timer { font-size: 13px; color: #777; margin-top: 5px; }
  </style>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
</head>

<body>
  <h2>üé• Random Video Chat</h2>
  <div id="videoContainer">
    <video id="remoteVideo" autoplay playsinline></video>
    <video id="localVideo" autoplay muted playsinline></video>
    <div id="waitingOverlay">üîç Waiting for partner...</div>
  </div>

  <div class="controls">
    <button id="startMale" class="male">Start ‚ôÇ Male</button>
    <button id="startFemale" class="female">Start ‚ôÄ Female</button>
    <button id="nextBtn" class="next" disabled>Find Next Partner</button>
    <button id="muteBtn" class="mic" disabled>Mic Off</button>
    <button id="camBtn" class="cam" disabled>Cam Off</button>
    <button id="cancelBtn" class="cancel" disabled>Cancel Connection</button>
    <span id="status">Idle</span>
    <span id="timer">Call Duration: 00:00</span>
  </div>

  <audio id="connectSound" src="https://www.myinstants.com/media/sounds/iphone-notification.mp3"></audio>

  <script>
    (async function () {
      // Firebase Config
      const firebaseConfig = {
        apiKey: "AIzaSyB1VbLbqBxCiG_bfGoQgQyapXwHUQ-Q7BU",
        authDomain: "tamil-chat-2d54e.firebaseapp.com",
        databaseURL: "https://tamil-chat-2d54e-default-rtdb.firebaseio.com",
        projectId: "tamil-chat-2d54e",
        storageBucket: "tamil-chat-2d54e.appspot.com",
        messagingSenderId: "804705969240",
        appId: "1:804705969240:web:658df281dd8360843c162d"
      };
      firebase.initializeApp(firebaseConfig);
      const db = firebase.database();

      const localVideo = document.getElementById('localVideo');
      const remoteVideo = document.getElementById('remoteVideo');
      const waitingOverlay = document.getElementById('waitingOverlay');
      const statusEl = document.getElementById('status');
      const connectSound = document.getElementById('connectSound');
      const timerEl = document.getElementById('timer');

      const startMale = document.getElementById('startMale');
      const startFemale = document.getElementById('startFemale');
      const nextBtn = document.getElementById('nextBtn');
      const cancelBtn = document.getElementById('cancelBtn');
      const muteBtn = document.getElementById('muteBtn');
      const camBtn = document.getElementById('camBtn');

      const clientId = 'c_' + Math.random().toString(36).substr(2, 8);
      let queueKey = null, callId = null, isInitiator = false;
      let pc = null, localStream = null;
      let localCandidatesRef = null, remoteCandidatesRef = null;
      const iceConfig = { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] };
      let timerInterval = null, startTime = null;

      function setStatus(msg) { statusEl.textContent = msg; }
      function showOverlay(show) { waitingOverlay.style.display = show ? 'flex' : 'none'; }

      async function getLocalStream() {
        if (localStream) return localStream;
        localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        localVideo.srcObject = localStream;
        return localStream;
      }

      async function enterQueue(gender) {
        const qRef = db.ref('queue');
        const newRef = qRef.push();
        queueKey = newRef.key;
        await newRef.set({ id: clientId, gender, ts: Date.now() });
        newRef.onDisconnect().remove();
        setStatus('Waiting for partner...');
        showOverlay(true);
        watchQueue();
        watchPairForUs();
      }

      function watchQueue() {
        db.ref('queue').on('child_added', async (snap) => {
          if (snap.key === queueKey) return;
          const otherKey = snap.key;
          const pairRef = db.ref('pairs/' + otherKey);
          await pairRef.transaction(current => {
            if (current === null) return { a: otherKey, b: queueKey, created: Date.now() };
          }, (err, committed, snap2) => {
            if (committed) {
              const ids = [otherKey, queueKey].sort();
              callId = "call_" + ids[0] + "_" + ids[1];
              isInitiator = true;
              db.ref('queue/' + otherKey).remove();
              db.ref('queue/' + queueKey).remove();
              startCall(callId);
            }
          });
        });
      }

      function watchPairForUs() {
        db.ref('pairs/' + queueKey).on('value', snap => {
          const val = snap.val();
          if (val && !callId) {
            const other = val.a === queueKey ? val.b : val.a;
            const ids = [other, queueKey].sort();
            callId = "call_" + ids[0] + "_" + ids[1];
            isInitiator = false;
            db.ref('queue/' + other).remove();
            db.ref('queue/' + queueKey).remove();
            startCall(callId);
          }
        });
      }

      async function startCall(id) {
        await getLocalStream();
        setStatus('Starting call...');
        pc = new RTCPeerConnection(iceConfig);

        localStream.getTracks().forEach(t => pc.addTrack(t, localStream));

        pc.ontrack = e => remoteVideo.srcObject = e.streams[0];
        pc.onicecandidate = e => {
          if (e.candidate && localCandidatesRef)
            localCandidatesRef.push(e.candidate.toJSON());
        };

        const callRef = db.ref('calls/' + id);
        const offerRef = callRef.child('offer');
        const answerRef = callRef.child('answer');
        localCandidatesRef = callRef.child(isInitiator ? 'offerCandidates' : 'answerCandidates');
        remoteCandidatesRef = callRef.child(isInitiator ? 'answerCandidates' : 'offerCandidates');

        remoteCandidatesRef.on('child_added', snap => {
          const c = snap.val();
          if (c) pc.addIceCandidate(new RTCIceCandidate(c));
        });

        if (isInitiator) {
          const offer = await pc.createOffer();
          await pc.setLocalDescription(offer);
          offerRef.set({ type: offer.type, sdp: offer.sdp });
          answerRef.on('value', async snap => {
            const data = snap.val();
            if (data && data.sdp) await pc.setRemoteDescription(new RTCSessionDescription(data));
          });
        } else {
          offerRef.on('value', async snap => {
            const data = snap.val();
            if (data && data.sdp && !pc.remoteDescription) {
              await pc.setRemoteDescription(new RTCSessionDescription(data));
              const answer = await pc.createAnswer();
              await pc.setLocalDescription(answer);
              answerRef.set({ type: answer.type, sdp: answer.sdp });
            }
          });
        }

        // enable buttons
        startMale.disabled = true;
        startFemale.disabled = true;
        nextBtn.disabled = false;
        cancelBtn.disabled = false;
        muteBtn.disabled = false;
        camBtn.disabled = false;

        setStatus('Connected!');
        showOverlay(false);
        startTimer();
        connectSound.play().catch(() => {});
      }

      async function hangUp() {
        if (pc) pc.close();
        if (callId) await db.ref('calls/' + callId).remove();
        if (queueKey) await db.ref('queue/' + queueKey).remove();

        if (localStream) {
          localStream.getTracks().forEach(t => t.stop());
          localVideo.srcObject = null;
          localStream = null;
        }

        if (remoteVideo.srcObject) {
          remoteVideo.srcObject.getTracks().forEach(t => t.stop?.());
          remoteVideo.srcObject = null;
        }

        callId = null;
        pc = null;

        startMale.disabled = false;
        startFemale.disabled = false;
        nextBtn.disabled = true;
        cancelBtn.disabled = true;
        muteBtn.disabled = true;
        camBtn.disabled = true;

        setStatus('Idle');
        stopTimer();
        showOverlay(true);
      }

      function startTimer() {
        startTime = Date.now();
        timerInterval = setInterval(() => {
          const diff = Date.now() - startTime;
          const mins = String(Math.floor(diff / 60000)).padStart(2, '0');
          const secs = String(Math.floor((diff % 60000) / 1000)).padStart(2, '0');
          timerEl.textContent = `Call Duration: ${mins}:${secs}`;
        }, 1000);
      }

      function stopTimer() {
        clearInterval(timerInterval);
        timerEl.textContent = 'Call Duration: 00:00';
      }

      // Buttons
      startMale.onclick = () => getLocalStream().then(() => enterQueue('male'));
      startFemale.onclick = () => getLocalStream().then(() => enterQueue('female'));
      nextBtn.onclick = async () => { await hangUp(); getLocalStream().then(() => enterQueue('any')); };
      cancelBtn.onclick = hangUp;

      muteBtn.onclick = () => {
        const t = localStream.getAudioTracks()[0];
        t.enabled = !t.enabled;
        muteBtn.textContent = t.enabled ? 'Mic Off' : 'Mic On';
      };

      camBtn.onclick = () => {
        const t = localStream.getVideoTracks()[0];
        t.enabled = !t.enabled;
        camBtn.textContent = t.enabled ? 'Cam Off' : 'Cam On';
      };
    })();
  </script>
</body>
</html>
