<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Random Video Chat - Tamil VM</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body{font-family:sans-serif;background:#111;color:#eee;margin:0;padding:20px;text-align:center}
    video{width:45%;max-width:400px;border-radius:10px;margin:5px;background:#000}
    .controls{margin-top:15px}
    button{padding:10px 15px;margin:5px;border:none;border-radius:6px;font-size:16px;cursor:pointer}
    button.primary{background:#10b981;color:#fff}
    button.secondary{background:#444;color:#fff}
    #status{display:block;margin-top:10px;color:#bbb}
  </style>
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
</head>
<body>
  <h2>ðŸ”¥ Random Video Chat - Tamil VM</h2>
  <video id="localVideo" autoplay muted playsinline></video>
  <video id="remoteVideo" autoplay playsinline></video>

  <div class="controls">
    <button id="startBtn" class="primary">Find Partner</button>
    <button id="hangBtn" class="secondary" disabled>Hang Up</button>
    <button id="muteBtn" class="secondary" disabled>Mute</button>
    <button id="camBtn" class="secondary" disabled>Camera Off</button>
    <span id="status">Idle</span>
  </div>

<script>
(async function(){
  // === Your Firebase Config ===
  const firebaseConfig = {
    apiKey: "AIzaSyB1VbLbqBxCiG_bfGoQgQyapXwHUQ-Q7BU",
    authDomain: "tamil-chat-2d54e.firebaseapp.com",
    databaseURL: "https://tamil-chat-2d54e-default-rtdb.firebaseio.com",
    projectId: "tamil-chat-2d54e",
    storageBucket: "tamil-chat-2d54e.appspot.com",
    messagingSenderId: "804705969240",
    appId: "1:804705969240:web:658df281dd8360843c162d"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // === UI Elements ===
  const localVideo = document.getElementById('localVideo');
  const remoteVideo = document.getElementById('remoteVideo');
  const startBtn = document.getElementById('startBtn');
  const hangBtn = document.getElementById('hangBtn');
  const muteBtn = document.getElementById('muteBtn');
  const camBtn = document.getElementById('camBtn');
  const statusEl = document.getElementById('status');

  // === Global State ===
  const clientId = 'c_' + Math.random().toString(36).substr(2,8);
  let queueKey = null, callId = null, isInitiator = false;
  let pc = null, localStream = null;
  let localCandidatesRef = null, remoteCandidatesRef = null;

  const iceConfig = { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] };

  function setStatus(msg){ statusEl.textContent = msg; }

  async function getLocalStream(){
    if(localStream) return localStream;
    localStream = await navigator.mediaDevices.getUserMedia({video:true,audio:true});
    localVideo.srcObject = localStream;
    return localStream;
  }

  async function enterQueue(){
    const qRef = db.ref('queue');
    const newRef = qRef.push();
    queueKey = newRef.key;
    await newRef.set({ id: clientId, ts: Date.now() });
    newRef.onDisconnect().remove();
    setStatus('Waiting for partner...');
    watchQueue();
    watchPairForUs();
  }

  function watchQueue(){
    db.ref('queue').on('child_added', async (snap) => {
      if(snap.key === queueKey) return;
      const otherKey = snap.key;
      const pairRef = db.ref('pairs/'+otherKey);
      await pairRef.transaction(current=>{
        if(current===null) return {a:otherKey,b:queueKey,created:Date.now()};
        return;
      }, async (err, committed, snap2)=>{
        if(committed){
          const ids = [otherKey, queueKey].sort();
          callId = "call_"+ids[0]+"_"+ids[1];
          isInitiator = true;
          db.ref('queue/'+otherKey).remove();
          db.ref('queue/'+queueKey).remove();
          startCall(callId);
        }
      });
    });
  }

  function watchPairForUs(){
    db.ref('pairs/'+queueKey).on('value', snap=>{
      const val = snap.val();
      if(val && !callId){
        const other = val.a===queueKey?val.b:val.a;
        const ids=[other,queueKey].sort();
        callId="call_"+ids[0]+"_"+ids[1];
        isInitiator=false;
        db.ref('queue/'+other).remove();
        db.ref('queue/'+queueKey).remove();
        startCall(callId);
      }
    });
  }

  async function startCall(id){
    await getLocalStream();
    setStatus('Starting call...');
    pc = new RTCPeerConnection(iceConfig);
    localStream.getTracks().forEach(t=>pc.addTrack(t,localStream));
    pc.ontrack = e=>{remoteVideo.srcObject=e.streams[0];};
    pc.onicecandidate = e=>{
      if(e.candidate && localCandidatesRef) localCandidatesRef.push(e.candidate.toJSON());
    };

    const callRef = db.ref('calls/'+id);
    const offerRef = callRef.child('offer');
    const answerRef = callRef.child('answer');
    localCandidatesRef = callRef.child(isInitiator?'offerCandidates':'answerCandidates');
    remoteCandidatesRef = callRef.child(isInitiator?'answerCandidates':'offerCandidates');

    remoteCandidatesRef.on('child_added', snap=>{
      const c=snap.val();
      if(c) pc.addIceCandidate(new RTCIceCandidate(c));
    });

    if(isInitiator){
      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);
      offerRef.set({type:offer.type,sdp:offer.sdp});
      answerRef.on('value', async snap=>{
        const data=snap.val();
        if(data && data.sdp) await pc.setRemoteDescription(new RTCSessionDescription(data));
      });
    }else{
      offerRef.on('value', async snap=>{
        const data=snap.val();
        if(data && data.sdp && !pc.remoteDescription){
          await pc.setRemoteDescription(new RTCSessionDescription(data));
          const answer=await pc.createAnswer();
          await pc.setLocalDescription(answer);
          answerRef.set({type:answer.type,sdp:answer.sdp});
        }
      });
    }

    startBtn.disabled=true;
    hangBtn.disabled=false;
    muteBtn.disabled=false;
    camBtn.disabled=false;
    setStatus('Connected!');
  }

  async function hangUp(){
    if(pc) pc.close();
    if(callId) await db.ref('calls/'+callId).remove();
    if(queueKey) await db.ref('queue/'+queueKey).remove();
    callId=null; pc=null;
    startBtn.disabled=false;
    hangBtn.disabled=true;
    muteBtn.disabled=true;
    camBtn.disabled=true;
    setStatus('Idle');
  }

  // UI events
  startBtn.onclick=()=>{getLocalStream().then(enterQueue);};
  hangBtn.onclick=hangUp;
  muteBtn.onclick=()=>{
    const t=localStream.getAudioTracks()[0];
    t.enabled=!t.enabled;
    muteBtn.textContent=t.enabled?'Mute':'Unmute';
  };
  camBtn.onclick=()=>{
    const t=localStream.getVideoTracks()[0];
    t.enabled=!t.enabled;
    camBtn.textContent=t.enabled?'Camera Off':'Camera On';
  };

})();
</script>
</body>
</html>
