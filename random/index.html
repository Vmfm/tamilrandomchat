<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Random Video Chat</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{margin:0;font-family:Arial;background:#000;color:#fff}
.hidden{display:none}
#login,#spinner{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:#000}
#loginBox{background:#111;padding:20px;border-radius:10px;width:300px}
input,select,button{width:100%;margin-top:10px;padding:10px;border-radius:6px;border:none}
button{background:#2563eb;color:#fff;font-size:16px}
#videoWrap{position:relative;height:100vh}
video{width:100%;height:100%;object-fit:cover;background:#000}
#local{position:absolute;top:10px;right:10px;width:150px;height:110px;border:2px solid #fff;border-radius:8px}
#spinner{flex-direction:column;font-size:20px}
.loader{width:40px;height:40px;border:5px solid #666;border-top:5px solid #fff;border-radius:50%;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
#info{position:absolute;bottom:10px;left:10px;background:rgba(0,0,0,.5);padding:8px;border-radius:6px}
.controls{position:absolute;bottom:10px;right:10px}
.controls button{margin-left:5px;width:auto}
</style>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
</head>

<body>

<!-- LOGIN -->
<div id="login">
  <div id="loginBox">
    <h3>Enter Details</h3>
    <input id="name" placeholder="Name">
    <input id="age" type="number" placeholder="Age">
    <select id="gender">
      <option value="">Gender</option>
      <option>Male</option>
      <option>Female</option>
      <option>Other</option>
    </select>
    <button onclick="saveProfile()">Continue</button>
  </div>
</div>

<!-- WAITING -->
<div id="spinner" class="hidden">
  <div class="loader"></div>
  <div style="margin-top:10px">Waiting for partnerâ€¦</div>
</div>

<!-- VIDEO -->
<div id="videoWrap" class="hidden">
  <video id="remote" autoplay playsinline></video>
  <video id="local" autoplay muted playsinline></video>

  <div id="info"></div>

  <div class="controls">
    <button onclick="next()">Next</button>
    <button onclick="hang()">Hang</button>
  </div>
</div>

<script>
/* FIREBASE */
firebase.initializeApp({
  apiKey: "AIzaSyAlWP5D79PsX29H0hIZlfvL0YV5Us7v5I4",
  authDomain: "sample-firebase-ai-app-1f408.firebaseapp.com",
  databaseURL: "https://sample-firebase-ai-app-1f408-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "sample-firebase-ai-app-1f408"
});
const db = firebase.database();

/* PROFILE */
let profile = JSON.parse(localStorage.getItem("profile"));
if(profile) document.getElementById("login").classList.add("hidden");

function saveProfile(){
  profile={
    name:name.value,
    age:age.value,
    gender:gender.value
  };
  if(!profile.name||!profile.age||!profile.gender) return alert("Fill all");
  localStorage.setItem("profile",JSON.stringify(profile));
  document.getElementById("login").classList.add("hidden");
}

/* WEBRTC */
let pc,localStream,callId,myId="u_"+Math.random().toString(36).slice(2);
const ice={iceServers:[{urls:"stun:stun.l.google.com:19302"}]};

async function start(){
  document.getElementById("spinner").classList.remove("hidden");
  localStream=await navigator.mediaDevices.getUserMedia({video:true,audio:true});
  local.srcObject=localStream;

  const q=db.ref("queue").push({id:myId,profile});
  q.onDisconnect().remove();

  db.ref("queue").on("child_added",snap=>{
    if(snap.val().id!==myId && !callId){
      callId="c_"+q.key+"_"+snap.key;
      db.ref("queue").remove();
      connect(callId,true,snap.val().profile);
    }
  });

  db.ref("pairs/"+myId).on("value",snap=>{
    if(snap.val()&&!callId){
      callId=snap.val().call;
      connect(callId,false,snap.val().profile);
    }
  });
}

async function connect(id,init,remoteProfile){
  document.getElementById("spinner").classList.add("hidden");
  document.getElementById("videoWrap").classList.remove("hidden");

  info.innerHTML=`Partner: ${remoteProfile.name}, ${remoteProfile.age}, ${remoteProfile.gender}`;

  pc=new RTCPeerConnection(ice);
  localStream.getTracks().forEach(t=>pc.addTrack(t,localStream));
  pc.ontrack=e=>remote.srcObject=e.streams[0];

  const ref=db.ref("calls/"+id);

  pc.onicecandidate=e=>e.candidate&&ref.child(init?"offerIce":"answerIce").push(e.candidate);

  ref.child(init?"answerIce":"offerIce").on("child_added",s=>pc.addIceCandidate(s.val()));

  if(init){
    const o=await pc.createOffer();
    await pc.setLocalDescription(o);
    ref.child("offer").set(o);
    ref.child("answer").on("value",async s=>{
      s.val()&&await pc.setRemoteDescription(s.val());
    });
  }else{
    ref.child("offer").once("value",async s=>{
      await pc.setRemoteDescription(s.val());
      const a=await pc.createAnswer();
      await pc.setLocalDescription(a);
      ref.child("answer").set(a);
    });
  }
}

function hang(){ location.reload(); }
function next(){ location.reload(); }

start();
</script>
</body>
</html>
