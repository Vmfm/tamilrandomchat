<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Tamil Chat App</title>

<style>
body{margin:0;font-family:Arial;background:#0b141a;color:#fff}
.hidden{display:none}
#login,#panel,#reportBox{position:fixed;inset:0;background:#000b;display:flex;align-items:center;justify-content:center;z-index:99}
.card{background:#111;padding:15px;border-radius:10px;width:95%;max-width:420px}
#top{background:#202c33;padding:10px;display:flex;align-items:center;justify-content:space-between}
#chat,#privateChat{height:calc(100vh - 120px);overflow:auto;padding:10px}
.msg{background:#2a3942;margin:5px 0;padding:8px;border-radius:8px;max-width:80%}
.self{background:#005c4b;margin-left:auto}
.badge{background:red;color:#fff;font-size:11px;padding:2px 6px;border-radius:10px}
.user{padding:8px;border-bottom:1px solid #222;display:flex;justify-content:space-between}
input,button{padding:8px;border-radius:6px;border:0}
button{background:#25d366}
img{border-radius:50%}
</style>
</head>

<body>

<div id="login">
  <div class="card">
    <h3>Enter Name</h3>
    <input id="name">
    <button onclick="join()">Join</button>
  </div>
</div>

<div id="panel" class="hidden">
  <div class="card">
    <h3>Settings</h3>
    <label><input type="checkbox" id="allowCalls" checked> Allow Calls</label><br>
    <label><input type="checkbox" id="allowPrivate" checked> Allow Private Chat</label><br><br>
    <button onclick="panel.classList.add('hidden')">Close</button>
  </div>
</div>

<div id="reportBox" class="hidden">
  <div class="card">
    <h3>Report User</h3>
    <textarea id="reportText" style="width:100%"></textarea><br>
    <button onclick="sendReport()">Submit</button>
  </div>
</div>

<div id="top">
  <b>Tamil Group Chat</b>
  <div>
    <span id="notify">üîî<span id="badge" class="badge hidden">0</span></span>
    <button onclick="panel.classList.remove('hidden')">‚öôÔ∏è</button>
  </div>
</div>

<div id="chat"></div>

<div style="display:flex;padding:8px">
  <input id="msg" style="flex:1">
  <button onclick="send()">Send</button>
</div>

<div id="privateBox" class="hidden">
  <div id="privateChat"></div>
  <input id="pmsg"><button onclick="sendPrivate()">Send</button>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>

<script>
firebase.initializeApp({
 apiKey:"AIzaSyB1VbLbqBxCiG_bfGoQgQyapXwHUQ-Q7BU",
 databaseURL:"https://tamil-chat-2d54e-default-rtdb.firebaseio.com",
 projectId:"tamil-chat-2d54e",
 storageBucket:"tamil-chat-2d54e.appspot.com"
});

const db=firebase.database(),st=firebase.storage();
let me=localStorage.name||"",privateWith="",unread=0,blocked=[];

/* LOGIN */
if(me)login.style.display="none",init();
function join(){me=name.value.trim();if(!me)return;localStorage.name=me;login.style.display="none";init();}

/* PRESENCE */
function init(){
 db.ref("presence/"+me).set(true);
 db.ref("presence/"+me).onDisconnect().remove();
 listenGroup(); listenTyping(); listenCalls();
}

/* GROUP CHAT */
function listenGroup(){
 db.ref("group").limitToLast(100).on("child_added",s=>{
  let m=s.val(); if(blocked.includes(m.name))return;
  let d=document.createElement("div");
  d.className="msg"+(m.name===me?" self":"");
  d.innerHTML="<b>"+m.name+"</b>: "+m.text;
  d.onclick=()=>openPrivate(m.name);
  chat.appendChild(d); chat.scrollTop=99999;
 });
}
function send(){
 if(!msg.value)return;
 db.ref("group").push({name:me,text:msg.value,time:Date.now()});
 msg.value="";
}

/* TYPING */
msg.oninput=()=>db.ref("typing/group/"+me).set(true);
function listenTyping(){
 db.ref("typing/group").on("value",s=>{});
}

/* PRIVATE CHAT */
function openPrivate(u){
 if(u===me)return;
 privateWith=u;
 privateChat.innerHTML="";
 privateBox.classList.remove("hidden");
 db.ref("private/"+[me,u].sort().join("_")).on("child_added",s=>{
  let m=s.val(); if(blocked.includes(m.name))return;
  let d=document.createElement("div");
  d.className="msg"+(m.name===me?" self":"");
  d.textContent=m.text;
  privateChat.appendChild(d); privateChat.scrollTop=99999;
 });
}
function sendPrivate(){
 if(!pmsg.value)return;
 db.ref("private/"+[me,privateWith].sort().join("_"))
 .push({name:me,text:pmsg.value,time:Date.now()});
 pmsg.value="";
}

/* UNREAD */
db.ref("notifications/"+me).on("child_added",()=>{
 unread++; badge.textContent=unread; badge.classList.remove("hidden");
});

/* BLOCK */
function block(u){blocked.push(u); db.ref("blocks/"+me+"/"+u).set(true);}
function unblock(u){blocked=blocked.filter(x=>x!==u); db.ref("blocks/"+me+"/"+u).remove();}

/* REPORT + AUTO BAN */
function report(u){
 reportBox.classList.remove("hidden");
 window.reportUser=u;
}
function sendReport(){
 db.ref("reports/"+reportUser).push({by:me,text:reportText.value});
 reportBox.classList.add("hidden");
}
db.ref("reports").on("child_added",s=>{
 if(s.numChildren()>3)db.ref("banned/"+s.key).set(true);
});

/* CALL SIGNALING */
function call(u){
 db.ref("calls").push({from:me,to:u,status:"ring"});
}
function listenCalls(){
 db.ref("calls").on("child_added",s=>{
  let c=s.val();
  if(c.to===me && c.status==="ring"){
   if(confirm("Call from "+c.from)){
    db.ref("calls/"+s.key+"/status").set("accept");
   }else db.ref("calls/"+s.key+"/status").set("decline");
  }
 });
}

/* PROFILE IMAGE */
function uploadPic(file){
 st.ref("profiles/"+me).put(file).then(r=>r.ref.getDownloadURL()
 .then(url=>db.ref("profiles/"+me).set(url)));
}
</script>

</body>
</html>
