<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Tamil VM Random Video</title>
<meta name="viewport" content="width=device-width,initial-scale=1">

<style>
body{margin:0;font-family:sans-serif;background:#111;color:#fff}
input,select,button{padding:10px;margin:5px;width:100%}
button{cursor:pointer}
#loginScreen{
  position:fixed;inset:0;background:#111;
  display:flex;align-items:center;justify-content:center;z-index:999
}
#loginBox{width:300px}
#videoContainer{position:relative;height:70vh;background:black}
video{width:100%;height:100%;object-fit:cover}
#localVideo{
  position:absolute;top:10px;right:10px;
  width:150px;height:110px;border:2px solid white
}
#waiting{
  position:absolute;inset:0;background:rgba(0,0,0,.7);
  display:flex;align-items:center;justify-content:center
}
#partnerInfo{
  position:absolute;bottom:10px;left:10px;
  background:rgba(0,0,0,.6);padding:8px;border-radius:6px;display:none
}
.controls{text-align:center;margin:10px}
</style>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
</head>

<body>

<!-- ðŸ” LOGIN -->
<div id="loginScreen">
  <div id="loginBox">
    <h2>Tamil VM Login</h2>

    <input id="nameInput" placeholder="Name">
    <input id="ageInput" type="number" placeholder="Age">

    <select id="genderInput">
      <option value="">Your Gender</option>
      <option value="Male">Male</option>
      <option value="Female">Female</option>
    </select>

    <select id="interestInput">
      <option value="">Interested In</option>
      <option value="Male">Male</option>
      <option value="Female">Female</option>
      <option value="Any">Any</option>
    </select>

    <button id="loginBtn">Continue</button>
  </div>
</div>

<h3 align="center">ðŸ”¥ Tamil VM Random Video</h3>

<div id="videoContainer">
  <video id="remoteVideo" autoplay playsinline></video>
  <video id="localVideo" autoplay muted playsinline></video>
  <div id="waiting">Waiting for partner...</div>
  <div id="partnerInfo"></div>
</div>

<div class="controls">
  <button id="startBtn">Find Partner</button>
  <button id="nextBtn" disabled>Next</button>
  <button id="hangBtn" disabled>Hang Up</button>
  <button id="reportBtn" disabled>ðŸš¨ Report & Block</button>
</div>

<script>
/* ðŸ”¥ FIREBASE */
firebase.initializeApp({
  apiKey: "AIzaSyAlWP5D79PsX29H0hIZlfvL0YV5Us7v5I4",
  databaseURL: "https://sample-firebase-ai-app-1f408-default-rtdb.asia-southeast1.firebasedatabase.app"
});
const db=firebase.database();

/* ðŸ” LOGIN LOGIC */
const loginScreen=document.getElementById("loginScreen");
const nameInput=document.getElementById("nameInput");
const ageInput=document.getElementById("ageInput");
const genderInput=document.getElementById("genderInput");
const interestInput=document.getElementById("interestInput");
const loginBtn=document.getElementById("loginBtn");

let profile=JSON.parse(localStorage.getItem("vm_profile"));
if(profile) loginScreen.style.display="none";

loginBtn.onclick=()=>{
  const name=nameInput.value.trim();
  const age=ageInput.value;
  const gender=genderInput.value;
  const interest=interestInput.value;

  if(!name||!age||!gender||!interest){
    alert("Fill all fields");
    return;
  }

  profile={name,age,gender,interest};
  localStorage.setItem("vm_profile",JSON.stringify(profile));
  loginScreen.style.display="none";
};

/* ðŸš« BLOCK LIST */
let blocked=JSON.parse(localStorage.getItem("vm_blocked")||"[]");

/* ðŸŽ¥ WEBRTC */
const clientId="c_"+Math.random().toString(36).substr(2,9);
let pc,callId,partnerId;
const ice={iceServers:[{urls:"stun:stun.l.google.com:19302"}]};

async function getStream(){
  const s=await navigator.mediaDevices.getUserMedia({video:true,audio:true});
  localVideo.srcObject=s;
  return s;
}

/* ðŸš» MATCH RULE */
function matchAllowed(other){
  if(blocked.includes(other.id)) return false;
  if(profile.interest!=="Any" && other.profile.gender!==profile.interest) return false;
  if(other.profile.interest!=="Any" && profile.gender!==other.profile.interest) return false;
  return true;
}

/* ðŸŽ¯ QUEUE */
async function enterQueue(){
  const q=db.ref("queue").push();
  await q.set({id:clientId,profile});
  q.onDisconnect().remove();

  db.ref("queue").on("child_added",snap=>{
    if(snap.key===q.key) return;
    const other=snap.val();
    if(!matchAllowed(other)) return;

    callId="call_"+snap.key+"_"+q.key;
    partnerId=other.id;
    db.ref("queue").remove();
    startCall(true);
  });
}

/* ðŸ“ž CALL */
async function startCall(init){
  const stream=await getStream();
  pc=new RTCPeerConnection(ice);
  stream.getTracks().forEach(t=>pc.addTrack(t,stream));
  pc.ontrack=e=>remoteVideo.srcObject=e.streams[0];

  const ref=db.ref("calls/"+callId);
  ref.child("profiles/"+clientId).set(profile);

  ref.child("profiles").on("value",s=>{
    const p=s.val();
    for(let k in p){
      if(k!==clientId){
        partnerInfo.innerHTML=`ðŸ‘¤ ${p[k].name}<br>ðŸŽ‚ ${p[k].age}<br>âš§ ${p[k].gender}`;
        partnerInfo.style.display="block";
      }
    }
  });

  if(init){
    const offer=await pc.createOffer();
    await pc.setLocalDescription(offer);
    ref.child("offer").set(offer);
    ref.child("answer").on("value",async s=>{
      if(s.val()) await pc.setRemoteDescription(s.val());
    });
  }else{
    ref.child("offer").on("value",async s=>{
      await pc.setRemoteDescription(s.val());
      const ans=await pc.createAnswer();
      await pc.setLocalDescription(ans);
      ref.child("answer").set(ans);
    });
  }

  waiting.style.display="none";
  startBtn.disabled=true;
  nextBtn.disabled=false;
  hangBtn.disabled=false;
  reportBtn.disabled=false;
}

/* ðŸš¨ REPORT & BLOCK */
reportBtn.onclick=()=>{
  db.ref("reports").push({
    reporter:clientId,
    reported:partnerId,
    time:Date.now()
  });
  blocked.push(partnerId);
  localStorage.setItem("vm_blocked",JSON.stringify(blocked));
  alert("User blocked");
  location.reload();
};

startBtn.onclick=enterQueue;
nextBtn.onclick=()=>location.reload();
hangBtn.onclick=()=>location.reload();
</script>

</body>
</html>
