<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">

<style>
:root{
  --bg:#111;--text:#fff;--panel:#000
}
body.light{
  --bg:#f4f4f4;--text:#111;--panel:#ddd
}
body{margin:0;font-family:sans-serif;background:var(--bg);color:var(--text)}

/* ğŸ” LOGIN */
#loginScreen{
  position:fixed;inset:0;background:var(--bg);
  display:flex;align-items:center;justify-content:center;z-index:999
}
input,select{padding:10px;margin:6px;width:100%}

/* ğŸ¥ VIDEO */
#videoContainer{
  position:relative;
  height:70vh;
  background:var(--panel);
  overflow:hidden;
}
video{width:100%;height:100%;object-fit:cover}
#localVideo{
  position:absolute;top:10px;right:10px;
  width:140px;height:100px;
  border:2px solid #fff;border-radius:6px;z-index:3
}

/* ğŸ”„ WAITING */
#waitingOverlay{
  position:absolute;inset:0;
  background:rgba(0,0,0,.7);
  display:flex;flex-direction:column;
  align-items:center;justify-content:center;
  z-index:2
}
.spinner{
  width:40px;height:40px;
  border:5px solid #777;
  border-top:5px solid #fff;
  border-radius:50%;
  animation:spin 1s linear infinite
}
@keyframes spin{to{transform:rotate(360deg)}}

/* ğŸ”˜ SMALL ICON BUTTONS */
.iconBtn{
  position:absolute;
  background:rgba(0,0,0,.6);
  color:#fff;border:none;
  padding:6px 8px;
  border-radius:6px;
  cursor:pointer;
  font-size:14px;
  z-index:3
}
#fullscreenBtn{top:10px;left:10px;display:none}
#muteBtn{top:10px;left:55px;display:none}
#themeBtn{top:10px;left:100px}

/* ğŸ‘¤ PARTNER INFO */
#partnerInfo{
  position:absolute;
  bottom:10px;left:10px;
  background:rgba(0,0,0,.6);
  padding:8px;border-radius:6px;
  display:none;z-index:3
}

/* â± TIMER */
#timer{
  text-align:center;
  margin:6px;
  font-size:14px;
  display:none
}

/* ğŸ› CONTROLS */
.controls{
  display:flex;
  justify-content:center;
  gap:10px;
  margin:12px
}
button{
  padding:10px 14px;
  border:none;border-radius:8px;
  font-size:15px;
  cursor:pointer;
  color:white
}
#findBtn{background:#10b981}
#nextBtn{background:#3b82f6}
#hangBtn{background:#ef4444}
#camBtn{background:#f59e0b}
button:disabled{opacity:.5}
</style>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
</head>

<body>

<!-- ğŸ” LOGIN -->
<div id="loginScreen">
  <div style="width:300px">
    <h2>Login</h2>
    <input id="nameInput" placeholder="Name">
    <input id="ageInput" type="number" placeholder="Age">

    <select id="genderInput">
      <option value="">Your Gender</option>
      <option>Male</option>
      <option>Female</option>
    </select>

    <select id="interestInput">
      <option value="">Interested In</option>
      <option>Male</option>
      <option>Female</option>
      <option>Any</option>
    </select>

    <button id="loginBtn" style="background:#2563eb;width:100%">Continue</button>
  </div>
</div>

<div id="videoContainer">
  <video id="remoteVideo" autoplay playsinline></video>
  <video id="localVideo" autoplay muted playsinline></video>

  <button id="fullscreenBtn" class="iconBtn">ğŸ–µ</button>
  <button id="muteBtn" class="iconBtn">ğŸ”‡</button>
  <button id="themeBtn" class="iconBtn">ğŸŒ™</button>

  <div id="waitingOverlay">
    <div class="spinner"></div>
    <div>Waiting for partner...</div>
  </div>

  <div id="partnerInfo"></div>
</div>

<div id="timer">Call Duration: 00:00</div>

<div class="controls">
  <button id="findBtn">Find</button>
  <button id="nextBtn" disabled>Next</button>
  <button id="hangBtn" disabled>Hang Up</button>
  <button id="camBtn" disabled>Camera Off</button>
</div>

<script>
/* ğŸ”¥ FIREBASE */
firebase.initializeApp({
  apiKey:"AIzaSyAlWP5D79PsX29H0hIZlfvL0YV5Us7v5I4",
  databaseURL:"https://sample-firebase-ai-app-1f408-default-rtdb.asia-southeast1.firebasedatabase.app"
});
const db=firebase.database();

/* ğŸ” LOGIN */
let profile=JSON.parse(localStorage.getItem("vm_profile"));
if(profile) loginScreen.style.display="none";

loginBtn.onclick=()=>{
  if(!nameInput.value||!ageInput.value||!genderInput.value||!interestInput.value){
    alert("Fill all fields");return;
  }
  profile={
    name:nameInput.value,
    age:ageInput.value,
    gender:genderInput.value,
    interest:interestInput.value
  };
  localStorage.setItem("vm_profile",JSON.stringify(profile));
  loginScreen.style.display="none";
};

/* ğŸ¥ CAMERA */
let localStream=null;
async function startCamera(){
  if(localStream) return;
  localStream=await navigator.mediaDevices.getUserMedia({video:true,audio:true});
  localVideo.srcObject=localStream;
}

/* â± TIMER */
let timerInt,startTime;
function startTimer(){
  timer.style.display="block";
  startTime=Date.now();
  timerInt=setInterval(()=>{
    const d=Date.now()-startTime;
    const m=String(Math.floor(d/60000)).padStart(2,'0');
    const s=String(Math.floor(d/1000)%60).padStart(2,'0');
    timer.textContent=`Call Duration: ${m}:${s}`;
  },1000);
}

/* ğŸ”— MATCH */
const clientId="c_"+Math.random().toString(36).substr(2,8);
let queueRef=null;

findBtn.onclick=async()=>{
  await startCamera();
  waitingOverlay.style.display="flex";

  queueRef=db.ref("queue").push();
  await queueRef.set({id:clientId,profile});
  queueRef.onDisconnect().remove();

  db.ref("queue").on("child_added",snap=>{
    if(snap.key===queueRef.key) return;

    waitingOverlay.style.display="none";
    fullscreenBtn.style.display="block";
    muteBtn.style.display="block";
    partnerInfo.style.display="block";

    partnerInfo.innerHTML=
      `ğŸ‘¤ ${snap.val().profile.name}<br>
       ğŸ‚ ${snap.val().profile.age}<br>
       âš§ ${snap.val().profile.gender}`;

    startTimer();

    nextBtn.disabled=false;
    hangBtn.disabled=false;
    camBtn.disabled=false;

    db.ref("queue/"+snap.key).remove();
    db.ref("queue/"+queueRef.key).remove();
  });
};

/* ğŸ”‡ MUTE */
muteBtn.onclick=()=>{
  const a=localStream.getAudioTracks()[0];
  a.enabled=!a.enabled;
  muteBtn.textContent=a.enabled?"ğŸ”‡":"ğŸ”Š";
};

/* ğŸŒ™ THEME */
themeBtn.onclick=()=>{
  document.body.classList.toggle("light");
  themeBtn.textContent=document.body.classList.contains("light")?"ğŸŒ":"ğŸŒ™";
};

/* ğŸ–µ FULLSCREEN */
fullscreenBtn.onclick=()=>{
  if(!document.fullscreenElement)
    videoContainer.requestFullscreen();
  else document.exitFullscreen();
};

/* ğŸ“· CAMERA TOGGLE */
camBtn.onclick=()=>{
  const v=localStream.getVideoTracks()[0];
  v.enabled=!v.enabled;
  camBtn.textContent=v.enabled?"Camera Off":"Camera On";
};

hangBtn.onclick=()=>location.reload();
nextBtn.onclick=()=>location.reload();
</script>

</body>
</html>
