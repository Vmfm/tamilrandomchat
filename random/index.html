<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">

<style>
:root{
  --bg:#111;--text:#fff;
  --panel:#000;--btn:#2563eb
}
body.light{
  --bg:#f5f5f5;--text:#111;
  --panel:#ddd
}
body{
  margin:0;font-family:sans-serif;
  background:var(--bg);color:var(--text)
}

/* LOGIN */
#loginScreen{
  position:fixed;inset:0;
  background:var(--bg);
  display:flex;align-items:center;justify-content:center;
  z-index:999
}
input,select,button{padding:10px;margin:6px;width:100%}

/* VIDEO */
#videoContainer{
  position:relative;
  height:70vh;
  background:var(--panel);
  overflow:hidden
}
video{width:100%;height:100%;object-fit:cover}
#localVideo{
  position:absolute;top:10px;right:10px;
  width:140px;height:100px;
  border:2px solid #fff;border-radius:6px;
  z-index:3
}

/* WAIT */
#waitingOverlay{
  position:absolute;inset:0;
  background:rgba(0,0,0,.7);
  display:flex;flex-direction:column;
  align-items:center;justify-content:center;
  z-index:2
}
.spinner{
  width:40px;height:40px;
  border:5px solid #777;
  border-top:5px solid #fff;
  border-radius:50%;
  animation:spin 1s linear infinite
}
@keyframes spin{to{transform:rotate(360deg)}}

/* TOP ICONS */
.iconBtn{
  position:absolute;top:10px;
  background:rgba(0,0,0,.6);
  border:none;color:#fff;
  padding:6px 10px;border-radius:6px;
  cursor:pointer;z-index:3
}
#fullscreenBtn{left:10px;display:none}
#themeBtn{left:60px}

/* INFO */
#partnerInfo{
  position:absolute;bottom:10px;left:10px;
  background:rgba(0,0,0,.6);
  padding:8px;border-radius:6px;
  display:none;z-index:3
}

/* CONTROLS */
.controls{
  display:flex;flex-wrap:wrap;
  justify-content:center;
  gap:10px;margin:10px
}
button{
  border:none;border-radius:8px;
  color:white;font-size:15px;
  cursor:pointer;padding:10px 14px
}
#findBtn{background:#10b981}
#nextBtn{background:#3b82f6}
#hangBtn{background:#ef4444}
#camBtn{background:#f59e0b}
#muteBtn{background:#8b5cf6}
#reportBtn{background:#dc2626}

/* TIMER */
#timer{
  text-align:center;
  font-size:14px;
  margin-bottom:8px;
  display:none
}
</style>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
</head>

<body>

<!-- LOGIN -->
<div id="loginScreen">
  <div style="width:300px">
    <h3>Login</h3>
    <input id="nameInput" placeholder="Name">
    <input id="ageInput" type="number" placeholder="Age">

    <select id="genderInput">
      <option value="">Your Gender</option>
      <option>Male</option>
      <option>Female</option>
    </select>

    <select id="interestInput">
      <option value="">Interested In</option>
      <option>Male</option>
      <option>Female</option>
      <option>Any</option>
    </select>

    <button id="loginBtn" style="background:#2563eb">Continue</button>
  </div>
</div>

<div id="videoContainer">
  <video id="remoteVideo" autoplay playsinline></video>
  <video id="localVideo" autoplay muted playsinline></video>

  <button id="fullscreenBtn" class="iconBtn">ðŸ–µ</button>
  <button id="themeBtn" class="iconBtn">ðŸŒ™</button>

  <div id="waitingOverlay">
    <div class="spinner"></div>
    <div>Waiting for partner...</div>
  </div>

  <div id="partnerInfo"></div>
</div>

<div id="timer">Call Duration: 00:00</div>

<div class="controls">
  <button id="findBtn">Find</button>
  <button id="nextBtn" disabled>Next</button>
  <button id="hangBtn" disabled>Hang Up</button>
  <button id="camBtn" disabled>Camera Off</button>
  <button id="muteBtn" disabled>Mute</button>
  <button id="reportBtn" disabled>ðŸš¨ Report & Block</button>
</div>

<script>
/* FIREBASE */
firebase.initializeApp({
  apiKey:"AIzaSyAlWP5D79PsX29H0hIZlfvL0YV5Us7v5I4",
  databaseURL:"https://sample-firebase-ai-app-1f408-default-rtdb.asia-southeast1.firebasedatabase.app"
});
const db=firebase.database();

/* LOGIN */
let profile=JSON.parse(localStorage.getItem("vm_profile"));
if(profile) loginScreen.style.display="none";

loginBtn.onclick=()=>{
  if(!nameInput.value||!ageInput.value||!genderInput.value||!interestInput.value){
    alert("Fill all fields");return;
  }
  profile={
    name:nameInput.value,
    age:ageInput.value,
    gender:genderInput.value,
    interest:interestInput.value
  };
  localStorage.setItem("vm_profile",JSON.stringify(profile));
  loginScreen.style.display="none";
};

/* BLOCK LIST */
let blocked=JSON.parse(localStorage.getItem("vm_blocked")||"[]");

/* CAMERA */
let localStream=null;
async function startCamera(){
  if(localStream) return;
  localStream=await navigator.mediaDevices.getUserMedia({video:true,audio:true});
  localVideo.srcObject=localStream;
}

/* MATCH */
const clientId="c_"+Math.random().toString(36).substr(2,8);
let queueRef=null,partnerId=null;

/* TIMER */
let timerInt,startTime;
function startTimer(){
  timer.style.display="block";
  startTime=Date.now();
  timerInt=setInterval(()=>{
    const d=Date.now()-startTime;
    const m=String(Math.floor(d/60000)).padStart(2,'0');
    const s=String(Math.floor(d/1000)%60).padStart(2,'0');
    timer.textContent=`Call Duration: ${m}:${s}`;
  },1000);
}

findBtn.onclick=async()=>{
  await startCamera();
  waitingOverlay.style.display="flex";

  queueRef=db.ref("queue").push();
  await queueRef.set({id:clientId,profile});
  queueRef.onDisconnect().remove();

  db.ref("queue").on("child_added",snap=>{
    if(snap.key===queueRef.key) return;
    if(blocked.includes(snap.val().id)) return;

    partnerId=snap.val().id;
    waitingOverlay.style.display="none";
    fullscreenBtn.style.display="block";

    partnerInfo.innerHTML=
      `ðŸ‘¤ ${snap.val().profile.name}<br>
       ðŸŽ‚ ${snap.val().profile.age}<br>
       âš§ ${snap.val().profile.gender}`;
    partnerInfo.style.display="block";

    startTimer();

    nextBtn.disabled=false;
    hangBtn.disabled=false;
    camBtn.disabled=false;
    muteBtn.disabled=false;
    reportBtn.disabled=false;

    db.ref("queue/"+snap.key).remove();
    db.ref("queue/"+queueRef.key).remove();
  });
};

/* BUTTONS */
camBtn.onclick=()=>{
  const v=localStream.getVideoTracks()[0];
  v.enabled=!v.enabled;
  camBtn.textContent=v.enabled?"Camera Off":"Camera On";
};

muteBtn.onclick=()=>{
  const a=localStream.getAudioTracks()[0];
  a.enabled=!a.enabled;
  muteBtn.textContent=a.enabled?"Mute":"Unmute";
};

fullscreenBtn.onclick=()=>{
  if(!document.fullscreenElement)
    videoContainer.requestFullscreen();
  else document.exitFullscreen();
};

themeBtn.onclick=()=>{
  document.body.classList.toggle("light");
  themeBtn.textContent=document.body.classList.contains("light")?"ðŸŒž":"ðŸŒ™";
};

reportBtn.onclick=()=>{
  db.ref("reports").push({
    reporter:clientId,
    reported:partnerId,
    time:Date.now()
  });
  blocked.push(partnerId);
  localStorage.setItem("vm_blocked",JSON.stringify(blocked));
  alert("User Reported & Blocked");
  location.reload();
};

hangBtn.onclick=()=>location.reload();
nextBtn.onclick=()=>location.reload();
</script>

</body>
</html>
