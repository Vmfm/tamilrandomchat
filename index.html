<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Simple Random Video Chat</title>
  <style>body{font-family:Arial;background:#111;color:#fff;margin:0}header{padding:12px;background:#0b1220}video{width:100%;height:300px;background:#000;object-fit:cover}</style>
</head>
<body>
  <header>
    <button id="start">Start</button>
    <button id="next" disabled>Next</button>
    <span id="status">Idle</span>
  </header>

  <main style="padding:12px;display:grid;grid-template-columns:1fr 1fr;gap:12px;">
    <div><h4>Remote</h4><video id="remote" autoplay playsinline></video></div>
    <div><h4>Local</h4><video id="local" autoplay playsinline muted></video></div>
  </main>

  <script>
    // EDIT this to your server WSS after you deploy it:
    const WS = 'wss://YOUR_SERVER_HERE';

    let ws, pc, localStream;
    const remoteVid = document.getElementById('remote');
    const localVid = document.getElementById('local');
    const startBtn = document.getElementById('start');
    const nextBtn = document.getElementById('next');
    const status = document.getElementById('status');

    function setStatus(t){ status.textContent = t; }

    async function getMedia(){
      localStream = await navigator.mediaDevices.getUserMedia({video:true,audio:true});
      localVid.srcObject = localStream;
    }

    function createPeer(){
      pc = new RTCPeerConnection({iceServers:[{urls:'stun:stun.l.google.com:19302'}]});
      localStream.getTracks().forEach(t=>pc.addTrack(t, localStream));
      pc.ontrack = e => remoteVid.srcObject = e.streams[0];
      pc.onicecandidate = e => { if(e.candidate) ws.send(JSON.stringify({type:'signal', data:{candidate:e.candidate}})); };
    }

    async function makeOffer(){ await pc.setLocalDescription(await pc.createOffer()); ws.send(JSON.stringify({type:'signal', data:{sdp: pc.localDescription}})); }

    async function handleSignal(data){
      if(data.sdp){
        await pc.setRemoteDescription(new RTCSessionDescription(data.sdp));
        if(data.sdp.type === 'offer'){
          await pc.setLocalDescription(await pc.createAnswer());
          ws.send(JSON.stringify({type:'signal', data:{sdp: pc.localDescription}}));
        }
      } else if(data.candidate){
        try{ await pc.addIceCandidate(data.candidate); }catch(e){}
      }
    }

    async function connectWS(){
      ws = new WebSocket(WS);
      ws.onopen = ()=>{ setStatus('WS open'); ws.send(JSON.stringify({type:'find'})); };
      ws.onclose = ()=> setStatus('WS closed');
      ws.onerror = ()=> setStatus('WS error');
      ws.onmessage = async (ev)=>{
        const msg = JSON.parse(ev.data);
        if(msg.type === 'id') document.title = 'ID:'+msg.id;
        else if(msg.type === 'waiting') setStatus('Waiting for partner...');
        else if(msg.type === 'paired'){
          setStatus('Paired with '+msg.partnerId);
          createPeer();
          // caller = lower id offers
          const myId = Number(document.title.split(':')[1]||0);
          if(myId <= msg.partnerId) await makeOffer();
          nextBtn.disabled = false;
        } else if(msg.type === 'signal') await handleSignal(msg.data);
        else if(msg.type === 'partner-left'){ setStatus('Partner left'); nextBtn.disabled = true; }
      };
    }

    startBtn.onclick = async () => {
      startBtn.disabled = true;
      setStatus('Getting media...');
      await getMedia();
      await connectWS();
    };

    nextBtn.onclick = ()=> { if(ws && ws.readyState===WebSocket.OPEN) ws.send(JSON.stringify({type:'find'})); setStatus('Finding new partner...'); };
  </script>
</body>
</html>
