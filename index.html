<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Random Video Chat</title>
  <style>
    body{margin:0;font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:#0b0b0f;color:#eaeaf0}
    .wrap{max-width:900px;margin:0 auto;padding:16px}
    h1{font-size:18px;margin:0 0 8px}
    .grid{display:grid;grid-template-columns:1fr;gap:10px}
    @media(min-width:860px){.grid{grid-template-columns:1fr 1fr}}
    video{width:100%;background:#000;aspect-ratio:16/9;border-radius:12px}
    .card{background:#16161d;border:1px solid #252633;border-radius:16px;padding:12px}
    .row{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .btn{border:0;padding:10px 12px;border-radius:12px;background:#2b2d3a;color:#fff;font-weight:600;cursor:pointer}
    .btn.primary{background:#5b8cff}
    .btn.danger{background:#ff5b6e;color:#000}
    .hint{opacity:.7;font-size:12px}
    #log{height:110px;overflow:auto;background:#0f1017;border:1px solid #22232b;border-radius:10px;padding:8px;font-size:12px}
    .badge{font-size:12px;padding:2px 8px;border-radius:999px;background:#0b6b37;color:#d6ffe9;border:1px solid #0a5b2f}
  </style>
</head>
<body>
  <!--
    HOW TO DEPLOY ON GITHUB PAGES
    1) Create a Firebase project → add Web App → copy config.
    2) Enable Realtime Database (test mode while testing).
    3) Paste your config in firebaseConfig below.
    4) Save this file as index.html in a repo → Settings → Pages → deploy from main branch.
  -->
  <div class="wrap">
    <div class="row" style="justify-content:space-between">
      <h1>Random Video Chat</h1>
      <span id="status" class="badge">idle</span>
    </div>

    <div class="grid">
      <div class="card">
        <div class="row" style="justify-content:space-between"><b>You</b><div class="row"><button class="btn" id="muteBtn">Mute</button><button class="btn" id="camBtn">Camera Off</button></div></div>
        <video id="localVideo" playsinline autoplay muted></video>
      </div>
      <div class="card">
        <b>Partner</b>
        <div class="hint">Appears after matching</div>
        <video id="remoteVideo" playsinline autoplay></video>
      </div>
    </div>

    <div class="card" style="margin-top:10px">
      <div class="row">
        <button class="btn primary" id="startBtn">Start</button>
        <button class="btn" id="nextBtn" disabled>Next</button>
        <button class="btn danger" id="endBtn" disabled>End</button>
      </div>
      <div id="log" style="margin-top:10px"></div>
    </div>
  </div>

  <!-- Firebase compat for simplicity -->
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-database-compat.js"></script>

  <script>
    // 1) PASTE YOUR FIREBASE CONFIG HERE
    const firebaseConfig = {
      apiKey: "
AIzaSyB1VbLbqBxCiG_bfGoQgQyapXwHUQ-Q7BU",
      authDomain: "PASTE.firebaseapp.com",
      databaseURL: "https://tamil-chat-2d54e-default-rtdb.firebaseio.com
",
      projectId: "tamil-chat-2d54e",
      storageBucket: "PASTE.appspot.com",
      messagingSenderId: "804705969240",
      appId: "1:804705969240:android:658df281dd8360843c162d
"
    };

    // ====== BASIC RANDOM MATCH + WEBRTC ======
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const $ = (s)=>document.querySelector(s);
    const logEl = $('#log');
    const statusEl = $('#status');
    const setStatus = (t)=>statusEl.textContent=t;
    const log = (m)=>{ const t=new Date().toLocaleTimeString(); logEl.innerHTML+=`[${t}] ${m}<br>`; logEl.scrollTop=logEl.scrollHeight; };

    let pc, localStream, roomRef, isCaller=false, myId=Math.random().toString(36).slice(2);

    const rtcConfig = {
      iceServers:[{urls:['stun:stun.l.google.com:19302','stun:stun1.l.google.com:19302']}]
      // TIP: add TURN here later for better connectivity
    };

    async function getMedia(){
      if(localStream) return localStream;
      localStream = await navigator.mediaDevices.getUserMedia({video:true,audio:true});
      $('#localVideo').srcObject = localStream; return localStream;
    }

    function createPC(){
      pc = new RTCPeerConnection(rtcConfig);
      localStream.getTracks().forEach(t=>pc.addTrack(t, localStream));
      pc.ontrack = (e)=>{ $('#remoteVideo').srcObject = e.streams[0]; };
      pc.onicecandidate = (e)=>{ if(e.candidate && roomRef){ roomRef.child('candidates').push({from:myId,candidate:e.candidate.toJSON()}); } };
      pc.onconnectionstatechange = ()=>{ log('State: '+pc.connectionState); if(pc.connectionState==='connected'){ setStatus('connected'); $('#nextBtn').disabled=false; $('#endBtn').disabled=false; } };
      return pc;
    }

    async function makeOffer(){
      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);
      await roomRef.child('offer').set({type:offer.type,sdp:offer.sdp});
    }

    async function joinWithOffer(offer){
      await pc.setRemoteDescription(new RTCSessionDescription(offer));
      const answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);
      await roomRef.child('answer').set({type:answer.type,sdp:answer.sdp});
    }

    function listenSignals(){
      roomRef.child('offer').on('value',async snap=>{ const v=snap.val(); if(!v||isCaller) return; log('Got offer'); await joinWithOffer(v); });
      roomRef.child('answer').on('value',async snap=>{ const v=snap.val(); if(!v||!isCaller) return; log('Got answer'); await pc.setRemoteDescription(new RTCSessionDescription(v)); });
      roomRef.child('candidates').on('child_added',async snap=>{ const c=snap.val(); if(!c||c.from===myId) return; try{ await pc.addIceCandidate(new RTCIceCandidate(c.candidate)); }catch(e){ log('ICE add error '+e.message); } });
    }

    async function match(){
      setStatus('matching…');
      const qRef = db.ref('queue/waiting');
      const result = await qRef.transaction(cur=>cur?null:{id:myId,ts:Date.now()});
      const snap = await qRef.get();
      if(snap.exists() && snap.val().id===myId){
        // we are the waiter
        const rid = `room_${myId}_${Math.random().toString(36).slice(2)}`;
        await db.ref(`waitingRooms/${myId}`).set({roomId:rid,createdAt:Date.now()});
        isCaller=true; return rid;
      } else {
        // we matched someone waiting
        const list = await db.ref('waitingRooms').limitToFirst(1).get();
        let rid=null, partner=null; list.forEach(ch=>{ rid=ch.val().roomId; partner=ch.key; });
        if(rid){ db.ref(`waitingRooms/${partner}`).remove(); }
        return rid || `room_${myId}_${Math.random().toString(36).slice(2)}`;
      }
    }

    async function start(){
      $('#startBtn').disabled=true; setStatus('starting…');
      await getMedia(); createPC();
      const roomId = await match();
      roomRef = db.ref('rooms').child(roomId); listenSignals();
      if(isCaller){ log('Creating offer…'); await makeOffer(); } else { log('Waiting for offer…'); }
    }

    async function next(){ await end(true); $('#startBtn').disabled=true; await start(); }

    async function end(keepMedia=false){
      setStatus('idle'); $('#nextBtn').disabled=true; $('#endBtn').disabled=true; $('#startBtn').disabled=false;
      try{ if(roomRef){ roomRef.remove(); roomRef.off(); } }catch{}
      try{ if(pc){ pc.getSenders().forEach(s=>{ try{s.track&&s.track.stop()}catch{} }); pc.close(); } }catch{}
      if(!keepMedia && localStream){ localStream.getTracks().forEach(t=>t.stop()); localStream=null; $('#localVideo').srcObject=null; }
      $('#remoteVideo').srcObject=null; isCaller=false;
    }

    // UI
    $('#startBtn').onclick = start;
    $('#nextBtn').onclick = next;
    $('#endBtn').onclick = ()=>end(false);
    $('#muteBtn').onclick = ()=>{ if(!localStream) return; const a=localStream.getAudioTracks(); a.forEach(t=>t.enabled=!t.enabled); $('#muteBtn').textContent=(a[0]&&a[0].enabled)?'Mute':'Unmute'; };
    $('#camBtn').onclick = ()=>{ if(!localStream) return; const v=localStream.getVideoTracks(); v.forEach(t=>t.enabled=!t.enabled); $('#camBtn').textContent=(v[0]&&v[0].enabled)?'Camera Off':'Camera On'; };

    // Clean up
    window.addEventListener('beforeunload',()=>{ try{ if(roomRef) roomRef.remove(); }catch{} });
  </script>
</body>
</html>
