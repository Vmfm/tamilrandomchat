<!DOCTYPE html>
<html>
<head>
  <title>Random Video Chat (GitHub Pages)</title>
  <style>
    body { font-family: sans-serif; text-align: center; }
    video { width: 45%; margin: 10px; border: 1px solid #ccc; }
  </style>
</head>
<body>
  <h2>ðŸ”€ Random Video Chat</h2>
  <p>Status: <span id="status">Waiting for match...</span></p>
  <video id="localVideo" autoplay muted playsinline></video>
  <video id="remoteVideo" autoplay playsinline></video>

  <!-- PeerJS Library -->
  <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>

  <script>
    const localVideo = document.getElementById("localVideo");
    const remoteVideo = document.getElementById("remoteVideo");
    const statusText = document.getElementById("status");

    let localStream;
    let peer;
    let conn;
    let call;

    // Generate a random ID
    const myId = "user-" + Math.floor(Math.random() * 1000000);

    // In-memory waiting pool (simulated)
    const peerListURL = "https://peerjs.com/peers"; // Just for fallback visual (not used)

    // 1. Set up PeerJS
    peer = new Peer(myId, {
      host: "peerjs.com",
      port: 443,
      secure: true
    });

    // 2. Get webcam
    navigator.mediaDevices.getUserMedia({ video: true, audio: true }).then(stream => {
      localVideo.srcObject = stream;
      localStream = stream;
    });

    // 3. Handle incoming calls
    peer.on("call", incomingCall => {
      statusText.textContent = "Matched! Receiving call...";
      incomingCall.answer(localStream);
      incomingCall.on("stream", remoteStream => {
        remoteVideo.srcObject = remoteStream;
      });
    });

    // 4. Try to match with another peer after delay
    peer.on("open", id => {
      console.log("My ID:", id);
      setTimeout(() => findRandomMatch(id), 2000);
    });

    // 5. Find random peer to connect with
    function findRandomMatch(myId) {
      fetch("https://0.peerjs.com/peers")
        .then(res => res.json())
        .then(peers => {
          const availablePeers = peers.filter(pid => pid !== myId && pid.startsWith("user-"));
          if (availablePeers.length === 0) {
            statusText.textContent = "Waiting for match...";
            setTimeout(() => findRandomMatch(myId), 3000);
          } else {
            const targetId = availablePeers[Math.floor(Math.random() * availablePeers.length)];
            statusText.textContent = "Connecting to: " + targetId;
            startCall(targetId);
          }
        }).catch(err => {
          statusText.textContent = "Error finding peers. Retry...";
          console.error(err);
          setTimeout(() => findRandomMatch(myId), 3000);
        });
    }

    // 6. Start the call
    function startCall(targetId) {
      call = peer.call(targetId, localStream);
      call.on("stream", remoteStream => {
        statusText.textContent = "Connected to " + targetId;
        remoteVideo.srcObject = remoteStream;
      });
      call.on("close", () => {
        statusText.textContent = "Call ended.";
      });
    }
  </script>
</body>
</html>
