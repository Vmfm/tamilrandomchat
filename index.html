<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Tamil VM Chat – Random Video</title>

<!-- PeerJS -->
<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

<style>
  :root {
    --bg1: #0f172a; /* slate-900 */
    --bg2: #1e293b; /* slate-800 */
    --card: #111827ee; /* gray-900 */
    --text: #e5e7eb;   /* gray-200 */
    --accent: #38bdf8; /* sky-400 */
    --accent-2: #22c55e; /* green-500 */
  }
  * { box-sizing: border-box; }
  html, body {
    margin: 0; padding: 0; height: 100%; font-family: system-ui, Arial, sans-serif;
    color: var(--text); background: radial-gradient(1200px 600px at 10% 0%, var(--bg2), var(--bg1));
  }
  .wrap { max-width: 960px; margin: 0 auto; padding: 16px 16px 80px; }
  header { text-align: center; margin: 14px 0 18px; }
  h1 { font-size: 22px; margin: 0 0 4px; letter-spacing: .3px; }
  .sub { font-size: 13px; opacity: .8; }

  .grid {
    display: grid; gap: 14px;
    grid-template-columns: 1fr;
  }
  @media (min-width: 900px) {
    .grid { grid-template-columns: 1fr 1fr; }
  }

  .card {
    background: var(--card); border: 1px solid #1f2937;
    border-radius: 16px; padding: 14px;
    box-shadow: 0 10px 30px rgba(0,0,0,.35);
  }
  .video {
    width: 100%; aspect-ratio: 16/9; background:#0b1220; border-radius: 12px; overflow: hidden;
  }
  video { width: 100%; height: 100%; object-fit: cover; background:#000; }

  .controls {
    display: flex; gap: 10px; flex-wrap: wrap; margin-top: 12px;
  }
  button {
    cursor: pointer; border: 1px solid #334155; background:#0b1220;
    color: var(--text); padding: 10px 14px; border-radius: 12px; font-weight: 600;
    transition: transform .08s ease, box-shadow .15s ease, border-color .15s ease;
  }
  button:hover { transform: translateY(-1px); border-color:#475569; }
  .primary { background: linear-gradient(90deg, var(--accent), #60a5fa); border: none; color:#0b1220; }
  .danger  { background: linear-gradient(90deg, #f43f5e, #fb7185); border: none; color:#0b1220; }
  .muted   { background:#111827; }

  .status {
    margin-top: 10px; font-size: 14px; line-height: 1.4;
    background:#0b1220; border:1px solid #1f2937; padding:10px 12px; border-radius: 10px;
  }
  .pill {
    display:inline-block; padding:3px 8px; border-radius:999px; background:#0b1220; border:1px solid #333; font-size:12px;
  }
  footer {
    position: fixed; inset-inline: 0; bottom: 0; text-align: center; padding: 10px; font-size: 12px;
    background: linear-gradient(0deg, rgba(0,0,0,.4), rgba(0,0,0,0));
  }
  .hint { opacity:.75; }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>Random Video Chat</h1>
    <div class="sub">Open this page on two devices and press <strong>Find Random Partner</strong>.</div>
  </header>

  <div class="grid">
    <section class="card">
      <div class="pill" id="myIdPill">ID: …</div>
      <div class="video"><video id="localVideo" autoplay playsinline muted></video></div>

      <div class="controls">
        <button id="btnFind" class="primary">Find Random Partner</button>
        <button id="btnNext" class="primary">Next</button>
        <button id="btnHang" class="danger">Hang Up</button>
        <button id="btnMic" class="muted">Mic On</button>
        <button id="btnCam" class="muted">Cam On</button>
      </div>

      <div class="status" id="status">Initializing…</div>
    </section>

    <section class="card">
      <div class="pill" id="peerPill">Partner: —</div>
      <div class="video"><video id="remoteVideo" autoplay playsinline></video></div>
      <div class="status" id="net">Network: Using public STUN + TURN (Metered.ca).</div>
    </section>
  </div>
</div>

<footer class="hint">Tip: If nothing happens, leave this page open for a few seconds so others can find you.</footer>

<script>
(() => {
  // ---------- Config ----------
  const APP_PREFIX = "tvm-";
  // Added free TURN servers
  const rtcConfig = {
    iceServers: [
      { urls: "stun:stun.l.google.com:19302" },
      { urls: "stun:stun1.l.google.com:19302" },
      {
        urls: "turn:global.relay.metered.ca:80",
        username: "openai",
        credential: "openai"
      },
      {
        urls: "turn:global.relay.metered.ca:443",
        username: "openai",
        credential: "openai"
      },
      {
        urls: "turns:global.relay.metered.ca:443",
        username: "openai",
        credential: "openai"
      }
    ]
  };

  // ---------- Elements ----------
  const elLocal = document.getElementById("localVideo");
  const elRemote = document.getElementById("remoteVideo");
  const elStatus = document.getElementById("status");
  const elMyIdPill = document.getElementById("myIdPill");
  const elPeerPill = document.getElementById("peerPill");
  const btnFind = document.getElementById("btnFind");
  const btnNext = document.getElementById("btnNext");
  const btnHang = document.getElementById("btnHang");
  const btnMic = document.getElementById("btnMic");
  const btnCam = document.getElementById("btnCam");

  // ---------- State ----------
  let peer, myId;
  let localStream = null;
  let currentCall = null;

  // ---------- Helpers ----------
  const setStatus = (msg) => { elStatus.textContent = msg; };
  const setPartner = (id) => { elPeerPill.textContent = "Partner: " + (id || "—"); };

  function randomId() {
    return APP_PREFIX + Math.random().toString(36).substring(2, 8);
  }

  function cleanupCall() {
    if (currentCall) {
      try { currentCall.close(); } catch {}
      currentCall = null;
    }
    elRemote.srcObject = null;
    setPartner("—");
  }

  function ensureMedia() {
    if (localStream) return Promise.resolve(localStream);
    return navigator.mediaDevices.getUserMedia({ video: true, audio: true })
      .then(stream => {
        localStream = stream;
        elLocal.srcObject = stream;
        btnMic.textContent = stream.getAudioTracks()[0]?.enabled ? "Mic On" : "Mic Off";
        btnCam.textContent = stream.getVideoTracks()[0]?.enabled ? "Cam On" : "Cam Off";
        return stream;
      });
  }

  // ---------- Init Peer ----------
  async function init() {
    setStatus("Requesting camera & mic…");
    try {
      await ensureMedia();
      setStatus("Starting PeerJS…");
    } catch (e) {
      setStatus("Permission needed for camera/mic. Error: " + e.message);
      return;
    }

    myId = randomId();
    peer = new Peer(myId, {
      config: rtcConfig,
      debug: 1
    });

    peer.on("open", (id) => {
      elMyIdPill.textContent = "ID: " + id;
      setStatus("Ready. Tap “Find Random Partner”.");
      peer.on("call", (call) => {
        setStatus("Incoming call… connecting");
        currentCall?.close?.();
        currentCall = call;
        ensureMedia().then(() => {
          call.answer(localStream);
          setPartner(call.peer);
          hookCallEvents(call);
        });
      });
    });

    peer.on("error", (err) => {
      setStatus("Peer error: " + err.type + " – " + (err.message || ""));
    });

    peer.on("disconnected", () => setStatus("Disconnected. Reconnecting…"));
    peer.on("close", () => setStatus("Connection closed."));
  }

  function hookCallEvents(call) {
    call.on("stream", (remoteStream) => {
      elRemote.srcObject = remoteStream;
      setStatus("Connected. Say hi! 🎉");
    });
    call.on("error", (err) => setStatus("Call error: " + err.message));
    call.on("close", () => {
      setStatus("Partner left.");
      cleanupCall();
    });
  }

  // ---------- Matchmaking ----------
  async function findRandomPartner() {
    if (!peer || peer.disconnected) {
      setStatus("Peer not ready yet. Please wait 1–2 seconds.");
      return;
    }
    setStatus("Searching for a random partner…");
    try {
      await ensureMedia();
      peer.listAllPeers((peers) => {
        const list = peers
          .filter(p => p.startsWith(APP_PREFIX) && p !== myId)
          .sort(() => Math.random() - 0.5);

        if (!list.length) {
          setStatus("No partner found right now. Waiting for someone to join… leave this page open.");
          return;
        }

        const partner = list[0];
        setPartner(partner);
        cleanupCall();
        const call = peer.call(partner, localStream, { metadata: { ts: Date.now() } });
        currentCall = call;
        hookCallEvents(call);
        setStatus("Calling " + partner + " …");
      });
    } catch (e) {
      setStatus("Find failed: " + e.message);
    }
  }

  // ---------- Buttons ----------
  btnFind.addEventListener("click", findRandomPartner);
  btnNext.addEventListener("click", () => {
    if (currentCall) { currentCall.close(); }
    setStatus("Finding next partner…");
    setTimeout(findRandomPartner, 200);
  });
  btnHang.addEventListener("click", () => {
    if (currentCall) { currentCall.close(); }
    setStatus("Call ended.");
  });

  btnMic.addEventListener("click", () => {
    if (!localStream) return;
    const t = localStream.getAudioTracks()[0];
    if (t) { t.enabled = !t.enabled; btnMic.textContent = t.enabled ? "Mic On" : "Mic Off"; }
  });

  btnCam.addEventListener("click", () => {
    if (!localStream) return;
    const t = localStream.getVideoTracks()[0];
    if (t) { t.enabled = !t.enabled; btnCam.textContent = t.enabled ? "Cam On" : "Cam Off"; }
  });

  // ---------- Start ----------
  init();
})();
</script>
</body>
</html>
